<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - status.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>status.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">64.36</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">452</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">52.48</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">4.67</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">const express = require(&#039;express&#039;);
const router = express.Router();
const db = require(&#039;../db&#039;);
const nodemailer = require(&#039;nodemailer&#039;);
const transporter = nodemailer.createTransport({
  host: &#039;smtp.gmail.com&#039;,
  port: 465,
  secure: true,
  service: &#039;gmail&#039;,
  auth: {
    user: process.env.GMAIL_USER,
    pass: process.env.GMAIL_PASS,
  },
});


router.get(&#039;/statusForBar/:candidateId&#039;, (req, res) =&gt; {
  const { candidateId } = req.params;

  const query = &#039;SELECT disposition_status, theme_status FROM diploma_status WHERE candidate_id = ? ORDER BY id DESC LIMIT 1&#039;;

  db.query(query, [candidateId], (error, results) =&gt; {
    if (error) {
      console.log(error);
      res.status(500).send(&#039;Error occurred during fetching status&#039;);
    } else {
      if (results.length === 0) {
        
        res.status(404).send(&#039;No status found for this candidate&#039;);
      } else {
        const dispositionStatus = results[0].disposition_status;
        const themeStatus = results[0].theme_status;
        console.log(dispositionStatus);
        console.log(themeStatus);

        
        let response = {
          text: &#039;Submit your Disposition and Theme Form&#039;,
          color: &#039;red&#039;,
          percentage: 0,
        };

        
        if (dispositionStatus !== &#039;&#039; || themeStatus !== &#039;&#039;) {
          if (dispositionStatus === &#039;Disposition Submitted&#039; &amp;&amp; themeStatus === &#039;Theme Submitted&#039;) {
            response = {
              text: &#039;Disposition and theme are submitted, wait for mentors response&#039;,
              color: &#039;orange&#039;,
              percentage: 40,
            };
          } else if (dispositionStatus === &#039;Disposition Disapproved&#039; &amp;&amp; themeStatus === &#039;Theme Submitted&#039;) {
            response = {
              text: &#039;Disposition disapproved, check under Diploma =&gt; Disapproved to see mentors comment and update your disposition&#039;,
              color: &#039;red&#039;,
              percentage: 30,
            };
          } else if (dispositionStatus === &#039;Disposition Submitted&#039; &amp;&amp; themeStatus === &#039;Theme Declined&#039;) {
            response = {
              text: &#039;Theme declined, update your theme in Diploma =&gt; Disapproved&#039;,
              color: &#039;red&#039;,
              percentage: 30,
            };
          } else if (dispositionStatus === &#039;Disposition Updated&#039; &amp;&amp; themeStatus === &#039;Theme Declined&#039;) {
            response = {
              text: &#039;Theme declined, update your theme in Diploma =&gt; Disapproved&#039;,
              color: &#039;red&#039;,
              percentage: 30,
            };
          } else if (dispositionStatus === &#039;Disposition Updated&#039; &amp;&amp; themeStatus === &#039;Theme Submitted&#039;) {
            response = {
              text: &#039;Disposition and theme are submitted. please wait for mentors response&#039;,
              color: &#039;orange&#039;,
              percentage: 50,
            };
          } else if (dispositionStatus === &#039;Disposition Approved&#039; &amp;&amp; themeStatus === &#039;Theme Declined&#039;) {
            response = {
              text: &#039;Theme declined, update your theme in Diploma =&gt; Disapproved&#039;,
              color: &#039;red&#039;,
              percentage: 40,
            };
          } else if (dispositionStatus === &#039;Disposition Approved&#039; &amp;&amp; themeStatus === &#039;Theme Submitted&#039;) {
            response = {
              text: &#039;You are almost there! Just wait for your mentor to send you signed document&#039;,
              color: &#039;blue&#039;,
              percentage: 70,
            };
          } else if (dispositionStatus === &#039;Disposition Approved&#039; &amp;&amp; themeStatus === &#039;Theme Accepted&#039;) {
            response = {
              text: &#039;Your mentor has sent you signed document, you can go and download it under Diploma =&gt; Download&#039;,
              color: &#039;lightseagreen&#039;,
              percentage: 90,
            };
          } else if (dispositionStatus === &#039;Disposition Downloaded&#039; &amp;&amp; themeStatus === &#039;Theme Accepted&#039;) {
            response = {
              text: &#039;Congratulations! Now start working on your diploma, watch out for deadlines!&#039;,
              color: &#039;green&#039;,
              percentage: 100,
            };
          } else {
            response = {
              text: &#039;Submit your Disposition and Theme Form&#039;,
              color: &#039;red&#039;,
              percentage: 0,
            };
          }
        }

        res.status(200).json(response);
      }
    }
  });
});
router.get(&#039;/diploma-status/current-user/:userId&#039;, async (req, res) =&gt; {

  const userId = req.params.userId;
  const query = `
      SELECT * FROM diploma_status WHERE candidate_id = ? AND progress_status IN (&quot;Thesis Submitted&quot;, &quot;Thesis Reviewed&quot;, &quot;Thesis Defended&quot;, &quot;Diploma Issued&quot;)`;
  db.query(query, [userId], (error, results) =&gt; {
    console.log(results)
    if (error) {
      console.log(error);
      res.status(500).send(&#039;Error occurred during fetching submitted dispositions&#039;);
    } else {
      const dispositions = results.map(disposition =&gt; ({
        id: disposition.id,
        mentorId: disposition.mentor_id,
        progressStatus: disposition.progress_status,
        deadline: disposition.deadline,
      }));
      res.status(200).send(dispositions);
    }
  });

});

router.put(&#039;/updateDeadline/:id&#039;, (req, res) =&gt; {
  const { deadline, candidateId } = req.body;
  const id = req.params.id;

  db.query(
    &#039;UPDATE diploma_status SET deadline = ? WHERE id = ?&#039;,
    [deadline, id],
    (error, results) =&gt; {
      if (error) {
        console.log(&#039;Database operation error:&#039;, error);
        return res.status(500).json({ error });
      }

      
      db.query(&#039;SELECT email,name FROM candidates WHERE id = ?&#039;, [candidateId], (error, results) =&gt; {
        if (error) {
          console.log(&#039;Database operation error:&#039;, error);
          return res.status(500).json({ error });
        }

        const candidateEmail = results[0].email;  
        const candidateName = results[0].name;  

        const mailOptions = {
          from: process.env.GMAIL_USER,
          to: candidateEmail,
          subject: &#039;Deadline Update&#039;,
          text: `Dear ${candidateName},\n\nYour deadline has been updated to ${deadline}.\n\nPlease log in to the system to check the details.\n`,
        };

        transporter.sendMail(mailOptions, (error, info) =&gt; {
          if (error) {
            console.log(&#039;Error occurred while sending email:&#039;, error);
          } else {
            console.log(&#039;Email sent:&#039;, info.response);
          }
        });

        res.json({ message: &#039;Deadline updated successfully!&#039; });
      });
    }
  );
});

router.put(&#039;/updateDefending/:id&#039;, async (req, res) =&gt; {
  const { deadline, candidateId } = req.body;
  const id = req.params.id;

  db.query(
    &#039;UPDATE diploma_status SET defending = ? WHERE id = ?&#039;,
    [deadline, id],
    (error, results) =&gt; {
      if (error) {
        console.log(&#039;Database operation error:&#039;, error);
        return res.status(500).json({ error });
      }

      
      db.query(&#039;SELECT email, name FROM candidates WHERE id = ?&#039;, [candidateId], (error, results) =&gt; {
        if (error) {
          console.log(&#039;Database operation error:&#039;, error);
          return res.status(500).json({ error });
        }

        const candidateEmail = results[0].email;  
        const candidateName = results[0].name;  

        const mailOptions = {
          from: process.env.GMAIL_USER,
          to: candidateEmail,
          subject: &#039;Defending Deadline Update&#039;,
          text: `Dear ${candidateName},\n\nYour defending deadline has been updated to ${deadline}.\n\nPlease log in to the system to check the details.\n`,
        };

        transporter.sendMail(mailOptions, (error, info) =&gt; {
          if (error) {
            console.log(&#039;Error occurred while sending email:&#039;, error);
          } else {
            console.log(&#039;Email sent:&#039;, info.response);
          }
        });

        res.json({ message: &#039;Defending deadline updated successfully!&#039; });
      });
    }
  );
});

router.put(&#039;/updateProgress/:dispositionId&#039;, async (req, res) =&gt; {
  try {
    const dispositionId = req.params.dispositionId;
    const { candidateId, mentorId, progressStatus } = req.body;
    
    let deadline = null;
    let defending = null;

    if (progressStatus === &#039;Thesis Reviewed&#039;) {
      const currentDate = new Date();
      const oneMonthFromNow = new Date(currentDate.getTime() + 30 * 24 * 60 * 60 * 1000); 
      deadline = oneMonthFromNow.toISOString().slice(0, 10); 
    } else if (progressStatus === &#039;Thesis Defended&#039;) {
      
      deadline = null;
      defending = null;
    }

    
    const updateQuery = &#039;UPDATE diploma_status SET progress_status = ?, deadline = ?, defending = ? WHERE id = ?&#039;;
    await db.query(updateQuery, [progressStatus, deadline, defending, dispositionId]);

    res.json({ message: &#039;Disposition status updated successfully.&#039; });
  } catch (error) {
    console.error(&#039;Error updating disposition status: &#039;, error);
    res.status(500).send(&#039;Internal Server Error&#039;);
  }
});

router.get(&#039;/accepted-themes/:candidateId&#039;, (req, res) =&gt; {
  const { candidateId } = req.params;

  const query = &#039;SELECT * FROM diploma_status WHERE candidate_id = ? AND theme_status = ?&#039;;

  db.query(query, [candidateId, &quot;Theme Accepted&quot;], (error, results) =&gt; {
    if (error) {
      console.log(error);
      res.status(500).send(&#039;Error occurred during fetching accepted themes&#039;);
    } else {
      const dispositions = results.map(disposition =&gt; ({
        id: disposition.id,
        candidateId: disposition.candidate_id,
        mentorId: disposition.mentor_id,
        dispositionPath: disposition.disposition,
        progressStatus: disposition.progress_status,
        deadline: disposition.deadline,
        defending: disposition.defending
      }));
      res.status(200).send(dispositions);
    }
  });
});

router.put(&#039;/diploma-status/update/:userId&#039;, async (req, res) =&gt; {
  const { userId } = req.params;
  const { progression_status } = req.body;
  let deadline = null;
  const currentDate = new Date();
  const oneYearFromNow = new Date(currentDate.setFullYear(currentDate.getFullYear() + 1));
  deadline = oneYearFromNow.toISOString().slice(0, 10);
  try {
    
    await db.query(&#039;UPDATE diploma_status SET progress_status = ? , deadline = ? WHERE candidate_id = ?&#039;, [progression_status, deadline, userId]);

    
    res.status(200).json({ message: &#039;Progression status updated successfully&#039; });
  } catch (error) {
    
    console.error(error);
    res.status(500).json({ error: &#039;An error occurred while updating the progression status&#039; });
  }
});

router.get(&#039;/diploma-status/thesis-submitted/:mentorId&#039;, (req, res) =&gt; {
  const { mentorId } = req.params;
  const query = `SELECT * FROM diploma_status WHERE mentor_id = ? AND (progress_status = &quot;Thesis Submitted&quot; OR progress_status = &quot;Thesis Reviewed&quot; OR progress_status = &quot;Thesis Defended&quot; OR progress_status = &quot;Diploma Issued&quot;)`;

  db.query(query, [mentorId], (error, results) =&gt; {
    if (error) {
      console.log(error);
      res.status(500).send(&#039;Error occurred during fetching submitted dispositions&#039;);
    } else {
      const dispositions = results.map(disposition =&gt; ({
        id: disposition.id,
        candidateId: disposition.candidate_id,
        mentorId: disposition.mentor_id,
        dispositionPath: disposition.disposition,
        progressStatus: disposition.progress_status,
        deadline: disposition.deadline
      }));
      res.status(200).send(dispositions);
    }
  });
});


router.get(&#039;/mentor/dispositionsCount/:mentorId&#039;, (req, res) =&gt; {
  const { mentorId } = req.params;
  const query = `SELECT COUNT(*) AS dispositionsCount FROM diploma_status 
                 WHERE mentor_id = ? AND 
                 (disposition_status = &#039;Disposition Submitted&#039; OR disposition_status = &#039;Disposition Updated&#039;)`;
  db.query(query, [mentorId], (error, results) =&gt; {
    if (error) {
      console.log(error);
      res.status(500).send(&#039;Error occurred during fetching dispositions count&#039;);
    } else {
      res.status(200).send(results[0]);
    }
  });
});


router.get(&#039;/mentor/themesCount/:mentorId&#039;, (req, res) =&gt; {
  const { mentorId } = req.params;
  const query = `SELECT COUNT(*) AS themesCount FROM diploma_status 
                 WHERE mentor_id = ? AND theme_status = &#039;Theme Submitted&#039;`;
  db.query(query, [mentorId], (error, results) =&gt; {
    if (error) {
      console.log(error);
      res.status(500).send(&#039;Error occurred during fetching themes count&#039;);
    } else {
      res.status(200).send(results[0]);
    }
  });
});


router.get(&#039;/mentor/candidates/:mentorId&#039;, (req, res) =&gt; {
  const { mentorId } = req.params;
  const query = &#039;SELECT id, name FROM candidates WHERE mentor_id = ?&#039;;
  db.query(query, [mentorId], (error, results) =&gt; {
    if (error) {
      console.log(error);
      res.status(500).send(&#039;Error occurred during fetching candidates&#039;);
    } else {
      const candidates = results.map(candidate =&gt; ({
        id: candidate.id,
        name: candidate.name
      }));
      const candidatesCount = candidates.length;
      res.status(200).send({ candidatesCount, candidates });
    }
  });
});

router.get(&#039;/calendar/:mentorId&#039;, (req, res) =&gt; {
  const { mentorId } = req.params;
  const query = &#039;SELECT candidate_id, name, deadline, defending FROM diploma_status INNER JOIN candidates ON diploma_status.candidate_id = candidates.id WHERE diploma_status.mentor_id = ?&#039;;;

  db.query(query, [mentorId], (error, results) =&gt; {
    if (error) {
      console.log(error);
      res.status(500).send(&#039;Error occurred during fetching calendar events&#039;);
    } else {
      const events = [];
      results.forEach((result) =&gt; {
        if (result.deadline) {
          events.push({
            title: result.name,
            start: formatDate(result.deadline),
            description: &quot;Deadline&quot;,
            color: &#039;#00080&#039;,
          });
        }
        if (result.defending) {
          events.push({
            title: result.name,
            start: formatDate(result.defending),
            description: &quot;Defending date&quot;,
            color: &#039;#800000&#039;,
          });
        }
      });

      function formatDate(dateString) {
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, &#039;0&#039;);
        const day = String(date.getDate()).padStart(2, &#039;0&#039;);
        return `${year}-${month}-${day}`;
      }
      console.log(events)
      res.status(200).send(events);
    }
  });
});

router.get(&#039;/mentorName/:mentorId&#039;, (req, res) =&gt; {
  const { mentorId } = req.params;
  const query = &#039;SELECT name FROM users WHERE id = ? &#039; ;

  db.query(query, [mentorId], (error, results) =&gt; {
    if (error) {
      console.log(error);
      res.status(500).send(&#039;Error occurred during fetching mentor name&#039;);
    } else {
      if (results.length &gt; 0) {
        const mentorName = results[0].name;
        console.log(&quot;mentors name is&quot;+mentorName)
        res.status(200).send({ name: mentorName });
      } else {
        res.status(404).send(&#039;No mentor with this id found&#039;);
      }
    }
  });
});

router.get(&#039;/mentor/data/:mentorId&#039;, (req, res) =&gt; {
  const { mentorId } = req.params;
  const query = &#039;SELECT progress_status, candidates.name FROM candidates inner join diploma_status on candidates.id = diploma_status.candidate_id WHERE diploma_status.mentor_id = ?&#039;;
  db.query(query, [mentorId], (error, results) =&gt; {
    if (error) {
      console.log(error);
      res.status(500).send(&#039;Error occurred during fetching candidates&#039;);
    } else {
      const candidates = results.map(candidate =&gt; ({
        id: candidate.id,
        name: candidate.name
      }));
      const candidatesCount = candidates.length;
      res.status(200).send({ candidatesCount, candidates });
    }
  });
});




module.exports = router;</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ cyclomatic }} <br>
    Length : {{ halstead.length }} <br>
    Difficulty : {{ halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
